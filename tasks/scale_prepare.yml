---
# Prepare node for installation

- name: prepare | Disable SELinux
  selinux:
    state: disabled
  notify: reboot

- name: prepare | Add Spectrum Scale directory to PATH
  lineinfile:
    path: /root/.bashrc
    line: PATH=$PATH:/usr/lpp/mmfs/bin
    state: present

#
# Configure SSH server
#
- name: prepare | Enable SSH root login
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: PermitRootLogin
    line: PermitRootLogin yes
    state: present
  notify: reload-sshd

- name: prepare | Enable SSH pubkey authentication
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: PubkeyAuthentication
    line: PubkeyAuthentication yes
    state: present
  notify: reload-sshd

- meta: flush_handlers

#
# Configure SSH client
#
- name: prepare | Disable SSH hostkey checking
  lineinfile:
    path: /etc/ssh/ssh_config
    regexp: StrictHostKeyChecking
    line: StrictHostKeyChecking no
    state: present

#
# Exchange SSH keys
#
- name: prepare | Generate SSH key
  vars:
    privkey_path: "{{ scale_prepare_pubkey_path | regex_replace('.pub$', '') }}"
  user:
    name: root
    generate_ssh_key: true
    ssh_key_file: "{{ privkey_path }}"

- name: prepare | Read public SSH key
  slurp:
    src: "{{ scale_prepare_pubkey_path }}"
  register: scale_prepare_pubkey

- name: prepare | Authorize all SSH keys
  authorized_key:
    user: root
    key: "{{ hostvars[item].scale_prepare_pubkey.content | b64decode }}"
    state: present
  with_items: "{{ ansible_play_hosts }}"

#
# Disable firewall
#
- name: prepare | List installed firewall RPMs
  yum:
    list: firewalld
  register: scale_prepare_firewallrpm
  when: ansible_pkg_mgr == 'yum'

- name: prepare | Stop and disable firewall
  service:
    name: firewalld
    state: stopped
    enabled: false
  when:
    - scale_prepare_disable_firewall
    - "'installed' in scale_prepare_firewallrpm.results | map(attribute='yumstate') | list"

#
# Install prereq RPMs
#
- name: prepare | Install prerequisite RPMs
  yum:
    name: yum-utils
    state: present
  when: ansible_pkg_mgr == 'yum'
